#!/usr/bin/env node

const basename = require("path").basename;
const { readFileSync, writeFileSync } = require("fs");
const loader = require("svg-inline-loader");

const destDir = "./src/icons/"
const files = process.argv.slice(2, process.argv.length).sort();
const fileHeader = `/* @flow */
/* Do not edit - Generated by iconify. See README.md for more details. */
/* eslint-disable max-len */`

if (!files.length) {
    console.log(`Usage: ./script/iconify ../ask-izzy-designs/icons/*`);
    console.log(`See README.md for more details.`);
    process.exit(1);
}

function toClassName(source_path) {
    return titleize(basename(source_path).
        replace("askizzy-icon-", '').
        replace(/.svg$/, '')
    )
}

function titleize(name) {
    const upcaseGroup = (match, char) => char.toUpperCase();

    return name
        .replace(/^(.)/, upcaseGroup)
        .replace(/-(.)/g, upcaseGroup);
}

files.forEach((path) => {
    const className = toClassName(path)
    const outFile = `${destDir}/${className}.js`;
    const svgContent = loader
        .getExtractedSVG(readFileSync(path))
        .replace(/^<svg/, "<svg class='${this.classNames}'")
        .replace(
            /style="([^"]*)"/g,
            (match, styleBlock) => styleBlock
                .split(";")
                .map((style) =>
                    style.replace(
                        /^(.*):(.*)$/,
                        (match, key, value) => `${key}="${value}"`,
                    )
                )
                .join(" ")
        );

    writeFileSync(outFile, `${fileHeader}

import BaseIcon from "./BaseIcon";

export default class SvgIcon${className} extends BaseIcon {
    static defaultProps: any = {
        iconClass: "${className}Icon",
    }

    svgContent: string = \`
        ${svgContent}
    \`;
}
`, 'utf8');
});


const importStatements = files.map((file) =>
    `import SvgIcon${toClassName(file)} from \"./${toClassName(file)}\";`
).join("\n");
const exportStatements = files.map((file) =>
    `    ${toClassName(file)}: SvgIcon${toClassName(file)},`
).join("\n")

writeFileSync("src/icons/index.js", `${fileHeader}
${importStatements}

export default {
${exportStatements}
};
`, 'utf8');
