#!/usr/bin/env bash

# Enable strict mode
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

export PATH=`npm bin`:$PATH
BOLD=$(tput bold)
END=$(tput sgr0)

function check {
    set -e
    echo "${BOLD}$1${END}"
    bash -c "$1"
    echo "Good"
}

export -f check

function checkFlowDefs {
echo "${BOLD}Checking for missing @flow comments${END}"
HAVE_FLOW=true
for file in $( git ls-files '**/*.js' ); do
    if [ -e "$file" ] ; then
        if [[ "$file" == external-resources-proxy/* ]]; then
            continue
        fi
        read flowtype < "$file"
        if test "x$flowtype" = 'x/* $FlowIgnore */'; then
            echo "Skipping disabled file $file" > /dev/null
        elif test "x$flowtype" != 'x/* @flow */'; then
            HAVE_FLOW=false
            cat << EOF
$file is not annotated for flowtype (must be the first line)! - got "$flowtype"
EOF
        fi
    fi
done

if ! $HAVE_FLOW ; then
    exit 1
fi
echo "Good"
}

export -f checkFlowDefs

function storybookCheck {
    failed=false
    for file in $(find src/components -iname '*.js'); do
        if [[ "$file" == *.stories.js || "$file" == *.service.js ]]; then
            continue
        fi
        parentDir=$(dirname "$file")
        name=$(basename "$file" ".js")
        if [ ! -f "$parentDir/$name.stories.js" ]; then
            failed=true
            echo 1>&2 "Component does not have storybook stories: $parentDir/$name.js"
        fi
    done
    if [[ "$failed" == "true" ]]; then
        exit 1
    fi
}

export -f storybookCheck

if which parallel > /dev/null ; then
    PVERSION=$( parallel --version | head -n 1 | cut -d' ' -f 3 )

    # Only use parallel if we have a recent version
    if [ "$PVERSION" -gt "20160000" ] ; then
        export SHELL=/bin/bash
        parallel --halt-on-error now,fail,1 ::: \
            storybookCheck \
            checkFlowDefs \
            'check "jsonlint package.json > /dev/null"' \
            'check "eslint src/ test/ fixtures/ webpack/ config/"' \
            'check "stylelint **/*.{css,scss,sass}"' \
            'check "flow"' \

        exit 0
    fi
fi

(./node_modules/.bin/flow start &>/dev/null) & # Pre-start flow server

storybookCheck
checkFlowDefs

check "jsonlint package.json > /dev/null"
check "eslint src/ test/ fixtures/ webpack/ config/ .storybook/"
check "stylelint **/*.{css,scss,sass}"
check "flow"

